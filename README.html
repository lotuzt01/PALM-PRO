<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalmCore Sawit Pro - Edisi Offline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="app" class="min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-green-900 text-white p-6 flex flex-col shrink-0">
            <div class="flex items-center gap-3 mb-10">
                <div class="bg-yellow-400 p-2 rounded-lg">
                    <i data-lucide="package" class="text-green-900"></i>
                </div>
                <h1 class="text-xl font-bold leading-tight">PalmCore<br><span class="text-yellow-400">Sawit Pro</span></h1>
            </div>

            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg bg-green-800">
                    <i data-lucide="layout-dashboard" size="20"></i> Dashboard
                </button>
                <button onclick="switchTab('pembelian')" id="nav-pembelian" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-green-800/50">
                    <i data-lucide="shopping-cart" size="20"></i> Pembelian (RAM)
                </button>
                <button onclick="switchTab('logistik')" id="nav-logistik" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-green-800/50">
                    <i data-lucide="truck" size="20"></i> Logistik & Jual
                </button>
                <button onclick="switchTab('keuangan')" id="nav-keuangan" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-green-800/50">
                    <i data-lucide="wallet" size="20"></i> Keuangan
                </button>
            </nav>

            <div class="mt-6 border-t border-green-800 pt-6">
                <div class="flex items-center gap-2 p-3 bg-black/20 rounded-lg">
                    <i data-lucide="hard-drive" size="14" class="text-yellow-400"></i>
                    <p class="text-[10px] font-bold uppercase text-yellow-400 tracking-widest">Mode Offline Aktif</p>
                </div>
                <p class="text-[9px] text-green-400 mt-2 italic text-center">Data tersimpan di memori browser ini.</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 id="tab-title" class="text-2xl font-black text-gray-800 uppercase tracking-tighter">Dashboard</h2>
                    <p class="text-gray-500 text-sm italic">Sistem Manajemen RAM Sawit Mandiri</p>
                </div>
                <div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-gray-200 flex items-center gap-3">
                    <div>
                        <span class="text-[10px] text-gray-400 block font-bold uppercase tracking-tight">Harga Beli RAM / Kg</span>
                        <div class="flex items-center gap-2">
                            <span id="display-price" class="font-black text-green-600">Rp 2.450</span>
                            <button onclick="toggleEditPrice()" class="text-gray-300 hover:text-green-600"><i data-lucide="edit-3" size="14"></i></button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Section: Dashboard -->
            <section id="section-dashboard" class="tab-content space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                        <div><p class="text-xs text-gray-400 font-bold uppercase">Stok RAM</p><h3 id="stat-stock" class="text-2xl font-black mt-1">0 Kg</h3></div>
                        <div class="p-3 rounded-xl bg-blue-600 text-white"><i data-lucide="package"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                        <div><p class="text-xs text-gray-400 font-bold uppercase">Kas Tunai</p><h3 id="stat-cash" class="text-2xl font-black mt-1">Rp 0</h3></div>
                        <div class="p-3 rounded-xl bg-green-600 text-white"><i data-lucide="wallet"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                        <div><p class="text-xs text-gray-400 font-bold uppercase">Truk OTW</p><h3 id="stat-otw" class="text-2xl font-black mt-1">0</h3></div>
                        <div class="p-3 rounded-xl bg-orange-600 text-white"><i data-lucide="truck"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                        <div><p class="text-xs text-gray-400 font-bold uppercase">Laba Estimasi</p><h3 id="stat-profit" class="text-2xl font-black mt-1">Rp 0</h3></div>
                        <div class="p-3 rounded-xl bg-indigo-600 text-white"><i data-lucide="trending-up"></i></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="history" class="text-gray-400"></i> Antrian Truk di PKS</h3>
                    <div id="otw-list" class="space-y-3 italic text-gray-400 text-sm py-4 text-center">Belum ada truk di perjalanan.</div>
                </div>
            </section>

            <!-- Section: Pembelian -->
            <section id="section-pembelian" class="tab-content hidden space-y-6">
                <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                    <div class="p-6 bg-green-900 text-white flex items-center gap-4">
                        <i data-lucide="scale" class="text-yellow-400"></i>
                        <h3 class="font-black text-xl">Input Timbangan Masuk</h3>
                    </div>
                    <form onsubmit="handleNewTransaction(event)" class="p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4 space-y-4">
                            <input type="text" id="in-farmer" placeholder="Nama Petani" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none focus:border-green-500" required>
                            <input type="text" id="in-truck" placeholder="No. Polisi (Opsional)" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="in-brutto" oninput="calcPurchase()" placeholder="Brutto" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none" required>
                                <input type="number" id="in-tara" oninput="calcPurchase()" placeholder="Tara" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none" required>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <label class="text-[10px] font-bold uppercase text-green-600">Potongan (%)</label>
                                <input type="number" id="in-potongan" oninput="calcPurchase()" value="2" class="w-full bg-transparent text-xl font-black outline-none text-green-700">
                            </div>
                        </div>
                        <div class="lg:col-span-8 bg-gray-50 rounded-3xl p-8 border-2 border-dashed border-gray-200 flex flex-col items-center justify-center text-center">
                            <p class="text-xs font-black text-gray-400 uppercase mb-2">Netto & Pembayaran</p>
                            <h2 id="calc-netto" class="text-6xl font-black text-gray-900 mb-2">0 <span class="text-xl">Kg</span></h2>
                            <h3 id="calc-total" class="text-3xl font-black text-green-600">Rp 0</h3>
                            <button type="submit" class="mt-8 w-full bg-green-600 text-white py-5 rounded-2xl font-black uppercase hover:bg-green-700 transition">Simpan Transaksi</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Section: Logistik -->
            <section id="section-logistik" class="tab-content hidden space-y-6">
                <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                    <div class="p-6 bg-indigo-900 text-white flex items-center gap-4">
                        <i data-lucide="truck" class="text-blue-300"></i>
                        <h3 class="font-black text-xl">Kirim Truk ke PKS</h3>
                    </div>
                    <form onsubmit="handleNewShipment(event)" class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <input type="text" id="ship-pks" placeholder="PKS Tujuan" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none" required>
                            <input type="text" id="ship-truck" placeholder="Plat Truk" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none" required>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="ship-brutto" placeholder="Brutto RAM" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none" required>
                                <input type="number" id="ship-tara" placeholder="Tara RAM" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none" required>
                            </div>
                            <input type="number" id="ship-price" value="2650" placeholder="Harga Jual PKS" class="w-full p-4 bg-indigo-50 border-2 border-indigo-100 rounded-xl font-black text-indigo-700 outline-none">
                        </div>
                        <div class="bg-gray-50 rounded-3xl p-8 border-2 border-dashed border-gray-200 flex flex-col items-center justify-center">
                            <button type="submit" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">Kirim Sekarang (OTW)</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Section: Keuangan -->
            <section id="section-keuangan" class="tab-content hidden space-y-8">
                <div class="bg-green-900 text-white p-8 rounded-3xl shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-green-300 text-sm font-bold uppercase mb-2">Saldo Tunai Saat Ini</p>
                        <h2 id="cash-large" class="text-5xl font-black tracking-tighter">Rp 0</h2>
                        <button onclick="editCashManual()" class="mt-4 text-xs font-bold text-yellow-400 uppercase flex items-center gap-1"><i data-lucide="edit-3" size="12"></i> Sesuaikan Saldo</button>
                    </div>
                    <div class="absolute -right-10 -bottom-10 w-48 h-48 bg-yellow-400/10 rounded-full"></div>
                </div>

                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 text-[10px] font-black uppercase text-gray-400">Tanggal</th>
                                <th class="p-4 text-[10px] font-black uppercase text-gray-400">Keterangan</th>
                                <th class="p-4 text-[10px] font-black uppercase text-gray-400">Volume</th>
                                <th class="p-4 text-[10px] font-black uppercase text-gray-400 text-right">Nominal</th>
                            </tr>
                        </thead>
                        <tbody id="history-list" class="text-sm">
                            <!-- Data JS -->
                        </tbody>
                    </table>
                </div>
                <button onclick="downloadCSV()" class="w-full py-4 border-2 border-green-600 text-green-600 rounded-xl font-black uppercase flex items-center justify-center gap-2 hover:bg-green-50">
                    <i data-lucide="download"></i> Download Laporan (CSV)
                </button>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <!-- Modal Konten Dinamis di sini -->
    </div>

    <script>
        // -- STATE MANAGEMENT (LOCAL STORAGE) --
        let state = {
            settings: { pricePerKg: 2450, cashBalance: 50000000 },
            transactions: [],
            shipments: []
        };

        function loadData() {
            const saved = localStorage.getItem('palmcore_data');
            if (saved) {
                state = JSON.parse(saved);
            }
            updateUI();
        }

        function saveData() {
            localStorage.setItem('palmcore_data', JSON.stringify(state));
            updateUI();
        }

        // -- UI UPDATES --
        function updateUI() {
            lucide.createIcons();
            
            // Dashboard Stats
            const totalBought = state.transactions.reduce((acc, t) => acc + t.netto2, 0);
            const totalSent = state.shipments.reduce((acc, s) => acc + s.nettoOut, 0);
            const stock = totalBought - totalSent;
            
            document.getElementById('display-price').innerText = `Rp ${state.settings.pricePerKg.toLocaleString()}`;
            document.getElementById('stat-stock').innerText = `${stock.toLocaleString()} Kg`;
            document.getElementById('stat-cash').innerText = `Rp ${state.settings.cashBalance.toLocaleString()}`;
            document.getElementById('cash-large').innerText = `Rp ${state.settings.cashBalance.toLocaleString()}`;
            document.getElementById('stat-otw').innerText = state.shipments.filter(s => s.status === 'OTW').length;
            
            // Laba (Sederhana: Hasil Jual - Modal Beli untuk yang Selesai)
            const completedShipments = state.shipments.filter(s => s.status === 'Selesai');
            const profit = completedShipments.reduce((acc, s) => acc + (s.totalJual - (s.nettoOut * s.avgBuyPrice)), 0);
            document.getElementById('stat-profit').innerText = `Rp ${profit.toLocaleString()}`;

            renderLists();
        }

        function renderLists() {
            // Render OTW List
            const otwDiv = document.getElementById('otw-list');
            const otwItems = state.shipments.filter(s => s.status === 'OTW');
            if (otwItems.length > 0) {
                otwDiv.innerHTML = otwItems.map(s => `
                    <div class="flex justify-between items-center p-4 bg-orange-50 border-l-4 border-orange-500 rounded-r-xl text-left italic-none mb-2">
                        <div>
                            <p class="font-bold text-gray-800 text-base">${s.truckNo} <span class="text-xs font-normal">→ ${s.pksName}</span></p>
                            <p class="text-[10px] uppercase font-bold text-gray-400">Muatan: ${s.nettoOut.toLocaleString()} Kg</p>
                        </div>
                        <button onclick="openFinalizeModal('${s.id}')" class="bg-orange-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold">INPUT STRUK</button>
                    </div>
                `).join('');
            } else {
                otwDiv.innerHTML = `<p class="py-4 italic text-gray-400 text-sm">Semua armada sudah bongkar.</p>`;
            }

            // Render History
            const histBody = document.getElementById('history-list');
            const allItems = [
                ...state.transactions.map(t => ({...t, type: 'BELI'})),
                ...state.shipments.filter(s => s.status === 'Selesai').map(s => ({...s, type: 'JUAL'}))
            ].sort((a,b) => b.timestamp - a.timestamp);

            histBody.innerHTML = allItems.map(item => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-4 text-xs font-medium text-gray-500">${new Date(item.timestamp).toLocaleDateString('id-ID')}</td>
                    <td class="p-4">
                        <p class="font-bold text-gray-800">${item.type === 'BELI' ? item.farmer : item.pksName}</p>
                        <p class="text-[10px] font-bold uppercase text-gray-400">${item.truckNo}</p>
                    </td>
                    <td class="p-4 font-bold">${(item.type === 'BELI' ? item.netto2 : item.nettoFinal).toLocaleString()} Kg</td>
                    <td class="p-4 text-right font-black ${item.type === 'BELI' ? 'text-red-600' : 'text-green-600'}">
                        ${item.type === 'BELI' ? '-' : '+'} Rp ${(item.type === 'BELI' ? item.totalBayar : item.totalJual).toLocaleString()}
                    </td>
                </tr>
            `).join('');
        }

        // -- TAB SWITCHING --
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-green-800'));
            
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('bg-green-800');
            document.getElementById('tab-title').innerText = tabId.charAt(0).toUpperCase() + tabId.slice(1);
            lucide.createIcons();
        }

        // -- CALCULATIONS --
        function calcPurchase() {
            const b = Number(document.getElementById('in-brutto').value) || 0;
            const t = Number(document.getElementById('in-tara').value) || 0;
            const p = Number(document.getElementById('in-potongan').value) || 0;
            
            const n1 = Math.max(0, b - t);
            const n2 = n1 - (n1 * (p/100));
            const total = n2 * state.settings.pricePerKg;
            
            document.getElementById('calc-netto').innerHTML = `${n2.toLocaleString()} <span class="text-xl">Kg</span>`;
            document.getElementById('calc-total').innerText = `Rp ${total.toLocaleString()}`;
            return { n2, total };
        }

        // -- HANDLERS --
        function handleNewTransaction(e) {
            e.preventDefault();
            const { n2, total } = calcPurchase();
            if (n2 <= 0) return alert("Netto tidak boleh nol!");

            const tx = {
                id: Date.now().toString(),
                timestamp: Date.now(),
                farmer: document.getElementById('in-farmer').value,
                truckNo: document.getElementById('in-truck').value || '-',
                netto2: n2,
                totalBayar: total
            };

            state.transactions.push(tx);
            state.settings.cashBalance -= total;
            saveData();
            e.target.reset();
            alert("Berhasil disimpan!");
            switchTab('dashboard');
        }

        function handleNewShipment(e) {
            e.preventDefault();
            const b = Number(document.getElementById('ship-brutto').value) || 0;
            const t = Number(document.getElementById('ship-tara').value) || 0;
            const n = Math.max(0, b-t);

            const ship = {
                id: Date.now().toString(),
                timestamp: Date.now(),
                pksName: document.getElementById('ship-pks').value,
                truckNo: document.getElementById('ship-truck').value,
                nettoOut: n,
                priceJualPks: Number(document.getElementById('ship-price').value),
                avgBuyPrice: state.settings.pricePerKg,
                status: 'OTW'
            };

            state.shipments.push(ship);
            saveData();
            e.target.reset();
            alert("Truk diberangkatkan!");
            switchTab('dashboard');
        }

        // -- MODALS & UPDATES --
        function toggleEditPrice() {
            const newPrice = prompt("Masukkan Harga RAM per Kg Baru:", state.settings.pricePerKg);
            if (newPrice && !isNaN(newPrice)) {
                state.settings.pricePerKg = Number(newPrice);
                saveData();
            }
        }

        function editCashManual() {
            const newCash = prompt("Masukkan Saldo Tunai Baru:", state.settings.cashBalance);
            if (newCash && !isNaN(newCash)) {
                state.settings.cashBalance = Number(newCash);
                saveData();
            }
        }

        function openFinalizeModal(id) {
            const ship = state.shipments.find(s => s.id === id);
            const modal = document.getElementById('modal-container');
            modal.innerHTML = `
                <div class="bg-white rounded-3xl w-full max-w-lg p-8 shadow-2xl space-y-6">
                    <h3 class="text-2xl font-black uppercase tracking-tighter text-gray-800">Finalisasi Bongkar PKS</h3>
                    <p class="text-sm text-gray-500 font-bold uppercase">${ship.truckNo} → ${ship.pksName}</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Netto Struk PKS (Kg)</label>
                            <input type="number" id="final-netto" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none border-indigo-100" placeholder="0">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Harga Jual Akhir</label>
                            <input type="number" id="final-price" value="${ship.priceJualPks}" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold outline-none border-indigo-100">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="flex-1 py-4 font-bold text-gray-400 uppercase">Batal</button>
                        <button onclick="finalizeShipment('${id}')" class="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-black uppercase tracking-widest">Selesai Bongkar</button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function finalizeShipment(id) {
            const nettoFinal = Number(document.getElementById('final-netto').value);
            const priceFinal = Number(document.getElementById('final-price').value);
            if (!nettoFinal) return alert("Input netto struk!");

            const idx = state.shipments.findIndex(s => s.id === id);
            const totalJual = nettoFinal * priceFinal;
            
            state.shipments[idx].nettoFinal = nettoFinal;
            state.shipments[idx].totalJual = totalJual;
            state.shipments[idx].status = 'Selesai';
            state.settings.cashBalance += totalJual;

            document.getElementById('modal-container').classList.add('hidden');
            saveData();
            alert("Transaksi Penjualan Berhasil!");
        }

        function downloadCSV() {
            let csv = "Tanggal,Tipe,Nama,Truk,Netto,Total Nominal\n";
            const allItems = [
                ...state.transactions.map(t => ({...t, type: 'BELI'})),
                ...state.shipments.filter(s => s.status === 'Selesai').map(s => ({...s, type: 'JUAL'}))
            ].sort((a,b) => b.timestamp - a.timestamp);

            allItems.forEach(item => {
                csv += `${new Date(item.timestamp).toLocaleDateString()},${item.type},${item.type === 'BELI' ? item.farmer : item.pksName},${item.truckNo},${item.type === 'BELI' ? item.netto2 : item.nettoFinal},${item.type === 'BELI' ? -item.totalBayar : item.totalJual}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `Laporan_RAM_Sawit_${new Date().toLocaleDateString()}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Initialize
        window.onload = loadData;
    </script>
</body>
</html>
